<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Hugo 0.35" />


<title>Iteratively applying models - A Hugo website</title>
<meta property="og:title" content="Iteratively applying models - A Hugo website">



  







<link rel="stylesheet" href="/css/fonts.css" media="all">
<link rel="stylesheet" href="/css/main.css" media="all">



  </head>
  <body>
    <div class="wrapper">
      <header class="header">
        <nav class="nav">
  <a href="/" class="nav-logo">
    <img src="/images/logo.png"
         width="50"
         height="50"
         alt="Logo">
  </a>

  <ul class="nav-links">
    
    <li><a href="/about/">About</a></li>
    
    <li><a href="https://github.com/rstudio/blogdown">GitHub</a></li>
    
    <li><a href="https://twitter.com/rstudio">Twitter</a></li>
    
  </ul>
</nav>

      </header>


<main class="content" role="main">

  <article class="article">
    
    <span class="article-duration">11 min read</span>
    

    <h1 class="article-title">Iteratively applying models</h1>

    
    <span class="article-date">2016/03/27</span>
    

    <div class="article-content">
      

<p>{% include _toc.html %}</p>

<p>I&rsquo;ve been doing a lot of programming in Python recently, and have taken my eye off the #RStats ball of late.
With a bit of time to play over the Easter weekend, I&rsquo;ve been reading <a href="https://twitter.com/hadleywickham">Hadley</a>&rsquo;s new <a href="http://r4ds.had.co.nz/">R for Data Science</a> book.</p>

<p>One thing I particularly like so far is the [purrr package]() which he describes in the <a href="http://r4ds.had.co.nz/lists.html">lists</a> chapter.
I&rsquo;ve always thought that the <code>sapply</code>,<code>lapply</code>, <code>vapply</code> (etc) commands are rather complicated.
The <strong>purrr</strong> package threatens to simplify this using the same left-to-right chaining framework that we have become used to in <a href="https://cran.r-project.org/web/packages/ggplot2/index.html"><strong>ggplot2</strong></a>, and more recently <a href="https://cran.r-project.org/web/packages/dplyr/index.html"><strong>dplyr</strong></a>.</p>

<p>Something I find myself doing more and more is subsetting a dataframe by a factor, and applying the same or a similar model to each subset of the data.
There are some new ways to do this in <strong>purrr</strong>.</p>

<h2 id="do">do()</h2>

<p>In this post I&rsquo;ll briefly explore some of the functions of <strong>purrr</strong>, and use them together with <strong>dplyr</strong> and <a href="https://cran.r-project.org/web/packages/broom/index.html"><strong>broom</strong></a> (as much for my own memory as anything else).</p>

<p>In the past I have used <code>dplyr::do()</code> to apply a model like so.</p>

<p>{% highlight r %}</p>

<h1 id="load-packages">Load packages</h1>

<p>library(dplyr)
library(lubridate)
library(magrittr)
library(broom)
library(ggplot2)</p>

<h1 id="in-case-you-haven-t-seen-mtcars-before-shame-on-you">In case you haven&rsquo;t seen mtcars before (shame on you)</h1>

<p>mtcars
{% endhighlight %}</p>

<p>{% highlight text %}</p>

<h2 id="mpg-cyl-disp-hp-drat-wt-qsec-vs-am-gear-carb">mpg cyl  disp  hp drat    wt  qsec vs am gear carb</h2>

<h2 id="mazda-rx4-21-0-6-160-0-110-3-90-2-620-16-46-0-1-4-4">Mazda RX4           21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4</h2>

<h2 id="mazda-rx4-wag-21-0-6-160-0-110-3-90-2-875-17-02-0-1-4-4">Mazda RX4 Wag       21.0   6 160.0 110 3.90 2.875 17.02  0  1    4    4</h2>

<h2 id="datsun-710-22-8-4-108-0-93-3-85-2-320-18-61-1-1-4-1">Datsun 710          22.8   4 108.0  93 3.85 2.320 18.61  1  1    4    1</h2>

<h2 id="hornet-4-drive-21-4-6-258-0-110-3-08-3-215-19-44-1-0-3-1">Hornet 4 Drive      21.4   6 258.0 110 3.08 3.215 19.44  1  0    3    1</h2>

<h2 id="hornet-sportabout-18-7-8-360-0-175-3-15-3-440-17-02-0-0-3-2">Hornet Sportabout   18.7   8 360.0 175 3.15 3.440 17.02  0  0    3    2</h2>

<h2 id="valiant-18-1-6-225-0-105-2-76-3-460-20-22-1-0-3-1">Valiant             18.1   6 225.0 105 2.76 3.460 20.22  1  0    3    1</h2>

<h2 id="duster-360-14-3-8-360-0-245-3-21-3-570-15-84-0-0-3-4">Duster 360          14.3   8 360.0 245 3.21 3.570 15.84  0  0    3    4</h2>

<h2 id="merc-240d-24-4-4-146-7-62-3-69-3-190-20-00-1-0-4-2">Merc 240D           24.4   4 146.7  62 3.69 3.190 20.00  1  0    4    2</h2>

<h2 id="merc-230-22-8-4-140-8-95-3-92-3-150-22-90-1-0-4-2">Merc 230            22.8   4 140.8  95 3.92 3.150 22.90  1  0    4    2</h2>

<h2 id="merc-280-19-2-6-167-6-123-3-92-3-440-18-30-1-0-4-4">Merc 280            19.2   6 167.6 123 3.92 3.440 18.30  1  0    4    4</h2>

<h2 id="merc-280c-17-8-6-167-6-123-3-92-3-440-18-90-1-0-4-4">Merc 280C           17.8   6 167.6 123 3.92 3.440 18.90  1  0    4    4</h2>

<h2 id="merc-450se-16-4-8-275-8-180-3-07-4-070-17-40-0-0-3-3">Merc 450SE          16.4   8 275.8 180 3.07 4.070 17.40  0  0    3    3</h2>

<h2 id="merc-450sl-17-3-8-275-8-180-3-07-3-730-17-60-0-0-3-3">Merc 450SL          17.3   8 275.8 180 3.07 3.730 17.60  0  0    3    3</h2>

<h2 id="merc-450slc-15-2-8-275-8-180-3-07-3-780-18-00-0-0-3-3">Merc 450SLC         15.2   8 275.8 180 3.07 3.780 18.00  0  0    3    3</h2>

<h2 id="cadillac-fleetwood-10-4-8-472-0-205-2-93-5-250-17-98-0-0-3-4">Cadillac Fleetwood  10.4   8 472.0 205 2.93 5.250 17.98  0  0    3    4</h2>

<h2 id="lincoln-continental-10-4-8-460-0-215-3-00-5-424-17-82-0-0-3-4">Lincoln Continental 10.4   8 460.0 215 3.00 5.424 17.82  0  0    3    4</h2>

<h2 id="chrysler-imperial-14-7-8-440-0-230-3-23-5-345-17-42-0-0-3-4">Chrysler Imperial   14.7   8 440.0 230 3.23 5.345 17.42  0  0    3    4</h2>

<h2 id="fiat-128-32-4-4-78-7-66-4-08-2-200-19-47-1-1-4-1">Fiat 128            32.4   4  78.7  66 4.08 2.200 19.47  1  1    4    1</h2>

<h2 id="honda-civic-30-4-4-75-7-52-4-93-1-615-18-52-1-1-4-2">Honda Civic         30.4   4  75.7  52 4.93 1.615 18.52  1  1    4    2</h2>

<h2 id="toyota-corolla-33-9-4-71-1-65-4-22-1-835-19-90-1-1-4-1">Toyota Corolla      33.9   4  71.1  65 4.22 1.835 19.90  1  1    4    1</h2>

<h2 id="toyota-corona-21-5-4-120-1-97-3-70-2-465-20-01-1-0-3-1">Toyota Corona       21.5   4 120.1  97 3.70 2.465 20.01  1  0    3    1</h2>

<h2 id="dodge-challenger-15-5-8-318-0-150-2-76-3-520-16-87-0-0-3-2">Dodge Challenger    15.5   8 318.0 150 2.76 3.520 16.87  0  0    3    2</h2>

<h2 id="amc-javelin-15-2-8-304-0-150-3-15-3-435-17-30-0-0-3-2">AMC Javelin         15.2   8 304.0 150 3.15 3.435 17.30  0  0    3    2</h2>

<h2 id="camaro-z28-13-3-8-350-0-245-3-73-3-840-15-41-0-0-3-4">Camaro Z28          13.3   8 350.0 245 3.73 3.840 15.41  0  0    3    4</h2>

<h2 id="pontiac-firebird-19-2-8-400-0-175-3-08-3-845-17-05-0-0-3-2">Pontiac Firebird    19.2   8 400.0 175 3.08 3.845 17.05  0  0    3    2</h2>

<h2 id="fiat-x1-9-27-3-4-79-0-66-4-08-1-935-18-90-1-1-4-1">Fiat X1-9           27.3   4  79.0  66 4.08 1.935 18.90  1  1    4    1</h2>

<h2 id="porsche-914-2-26-0-4-120-3-91-4-43-2-140-16-70-0-1-5-2">Porsche 914-2       26.0   4 120.3  91 4.43 2.140 16.70  0  1    5    2</h2>

<h2 id="lotus-europa-30-4-4-95-1-113-3-77-1-513-16-90-1-1-5-2">Lotus Europa        30.4   4  95.1 113 3.77 1.513 16.90  1  1    5    2</h2>

<h2 id="ford-pantera-l-15-8-8-351-0-264-4-22-3-170-14-50-0-1-5-4">Ford Pantera L      15.8   8 351.0 264 4.22 3.170 14.50  0  1    5    4</h2>

<h2 id="ferrari-dino-19-7-6-145-0-175-3-62-2-770-15-50-0-1-5-6">Ferrari Dino        19.7   6 145.0 175 3.62 2.770 15.50  0  1    5    6</h2>

<h2 id="maserati-bora-15-0-8-301-0-335-3-54-3-570-14-60-0-1-5-8">Maserati Bora       15.0   8 301.0 335 3.54 3.570 14.60  0  1    5    8</h2>

<h2 id="volvo-142e-21-4-4-121-0-109-4-11-2-780-18-60-1-1-4-2">Volvo 142E          21.4   4 121.0 109 4.11 2.780 18.60  1  1    4    2</h2>

<p>{% endhighlight %}</p>

<p>{% highlight r %}</p>

<h1 id="subset-by-number-of-cylinders-and-apply-a-linear-model-to-each-subset">Subset by number of cylinders, and apply a linear model to each subset</h1>

<p>subset_models &lt;- mtcars %&gt;%
  group_by(
    cyl
  ) %&gt;%
  do(fit = lm(mpg ~ wt, data = .))</p>

<p>subset_models
{% endhighlight %}</p>

<p>{% highlight text %}</p>

<h2 id="source-local-data-frame-3-x-2">Source: local data frame [3 x 2]</h2>

<h2 id="groups-by-row">Groups: <by row></h2>

<h2 id="cyl-fit">cyl      fit</h2>

<h2 id="dbl-list"><dbl>   <list></h2>

<h2 id="1-4-s3-lm">1     4 <S3: lm></h2>

<h2 id="2-6-s3-lm">2     6 <S3: lm></h2>

<h2 id="3-8-s3-lm">3     8 <S3: lm></h2>

<p>{% endhighlight %}</p>

<p>This results in three models, one each for 4, 6, and 8 cylinders,</p>

<p>We can now use a second call to <code>do()</code>, <code>dplyr::summarise()</code> or <code>dplyr::mutate</code> to extract elements from these models: for example extract the coefficients&hellip;</p>

<p>{% highlight r %}</p>

<h1 id="get-the-model-coefficients-and-coerce-into-a-dataframe">Get the model coefficients, and coerce into a dataframe</h1>

<p>subset_models %&gt;%
  do(as.data.frame(coef(.$fit)))
{% endhighlight %}</p>

<p>{% highlight text %}</p>

<h2 id="source-local-data-frame-6-x-1">Source: local data frame [6 x 1]</h2>

<h2 id="groups-by-row-1">Groups: <by row></h2>

<h2 id="coef-fit">coef(.$fit)</h2>

<h2 id="dbl"><dbl></h2>

<h2 id="1-39-571196">1   39.571196</h2>

<h2 id="2-5-647025">2   -5.647025</h2>

<h2 id="3-28-408845">3   28.408845</h2>

<h2 id="4-2-780106">4   -2.780106</h2>

<h2 id="5-23-868029">5   23.868029</h2>

<h2 id="6-2-192438">6   -2.192438</h2>

<p>{% endhighlight %}</p>

<p>We can also use <code>mutate()</code> to extract one or more elements</p>

<p>{% highlight r %}
subset_models %&gt;%
  mutate(
    a = coef(fit)[<a href="1" title="https://github.com/hadley/purrr
">1</a>],
    b = coef(fit)[[2]],
    R2 = summary(fit)$r.squared,
    adjustedR2 = summary(fit)$adj.r.squared
  )
{% endhighlight %}</p>

<p>{% highlight text %}</p>

<h2 id="source-local-data-frame-3-x-6">Source: local data frame [3 x 6]</h2>

<h2 id="groups-by-row-2">Groups: <by row></h2>

<h2 id="cyl-fit-a-b-r2-adjustedr2">cyl      fit        a         b        R2 adjustedR2</h2>

<h2 id="dbl-list-dbl-dbl-dbl-dbl"><dbl>   <list>    <dbl>     <dbl>     <dbl>      <dbl></h2>

<h2 id="1-4-s3-lm-39-57120-5-647025-0-5086326-0-4540362">1     4 <S3: lm> 39.57120 -5.647025 0.5086326  0.4540362</h2>

<h2 id="2-6-s3-lm-28-40884-2-780106-0-4645102-0-3574122">2     6 <S3: lm> 28.40884 -2.780106 0.4645102  0.3574122</h2>

<h2 id="3-8-s3-lm-23-86803-2-192438-0-4229655-0-3748793">3     8 <S3: lm> 23.86803 -2.192438 0.4229655  0.3748793</h2>

<p>{% endhighlight %}</p>

<h2 id="the-broom-package">The broom package</h2>

<p>If we want to get a tidier output, we can use the <code>broom</code> package, which provides three levels of aggregation.</p>

<p><code>glance</code> gives a single line for each model, similar to the <code>do()</code> and <code>summarise()</code> calls above:</p>

<p>{% highlight r %}
subset_models %&gt;%
  glance(fit)
{% endhighlight %}</p>

<p>{% highlight text %}</p>

<h2 id="source-local-data-frame-3-x-12">Source: local data frame [3 x 12]</h2>

<h2 id="groups-cyl-3">Groups: cyl [3]</h2>

<h2 id="cyl-r-squared-adj-r-squared-sigma-statistic-p-value-df">cyl r.squared adj.r.squared    sigma statistic    p.value    df</h2>

<h2 id="dbl-dbl-dbl-dbl-dbl-dbl-int"><dbl>     <dbl>         <dbl>    <dbl>     <dbl>      <dbl> <int></h2>

<h2 id="1-4-0-5086326-0-4540362-3-332283-9-316233-0-01374278-2">1     4 0.5086326     0.4540362 3.332283  9.316233 0.01374278     2</h2>

<h2 id="2-6-0-4645102-0-3574122-1-165202-4-337245-0-09175766-2">2     6 0.4645102     0.3574122 1.165202  4.337245 0.09175766     2</h2>

<h2 id="3-8-0-4229655-0-3748793-2-024091-8-795985-0-01179281-2">3     8 0.4229655     0.3748793 2.024091  8.795985 0.01179281     2</h2>

<h2 id="variables-not-shown-loglik-dbl-aic-dbl-bic-dbl-deviance-dbl">Variables not shown: logLik <dbl>, AIC <dbl>, BIC <dbl>, deviance <dbl>,</h2>

<h2 id="df-residual-int">df.residual <int>.</h2>

<p>{% endhighlight %}</p>

<p><code>tidy()</code> gives details of the model coefficicents:</p>

<p>{% highlight r %}
subset_models %&gt;%
  tidy(fit)
{% endhighlight %}</p>

<p>{% highlight text %}</p>

<h2 id="source-local-data-frame-6-x-6">Source: local data frame [6 x 6]</h2>

<h2 id="groups-cyl-3-1">Groups: cyl [3]</h2>

<h2 id="cyl-term-estimate-std-error-statistic-p-value">cyl        term  estimate std.error statistic      p.value</h2>

<h2 id="dbl-chr-dbl-dbl-dbl-dbl"><dbl>       <chr>     <dbl>     <dbl>     <dbl>        <dbl></h2>

<h2 id="1-4-intercept-39-571196-4-3465820-9-103980-7-771511e-06">1     4 (Intercept) 39.571196 4.3465820  9.103980 7.771511e-06</h2>

<h2 id="2-4-wt-5-647025-1-8501185-3-052251-1-374278e-02">2     4          wt -5.647025 1.8501185 -3.052251 1.374278e-02</h2>

<h2 id="3-6-intercept-28-408845-4-1843688-6-789278-1-054844e-03">3     6 (Intercept) 28.408845 4.1843688  6.789278 1.054844e-03</h2>

<h2 id="4-6-wt-2-780106-1-3349173-2-082605-9-175766e-02">4     6          wt -2.780106 1.3349173 -2.082605 9.175766e-02</h2>

<h2 id="5-8-intercept-23-868029-3-0054619-7-941551-4-052705e-06">5     8 (Intercept) 23.868029 3.0054619  7.941551 4.052705e-06</h2>

<h2 id="6-8-wt-2-192438-0-7392393-2-965803-1-179281e-02">6     8          wt -2.192438 0.7392393 -2.965803 1.179281e-02</h2>

<p>{% endhighlight %}</p>

<p><code>augment()</code> returns a row for each data point in the original data with relevant model outputs</p>

<p>{% highlight r %}
subset_models %&gt;%
  augment(fit)
{% endhighlight %}</p>

<p>{% highlight text %}</p>

<h2 id="source-local-data-frame-32-x-10">Source: local data frame [32 x 10]</h2>

<h2 id="groups-cyl-3-2">Groups: cyl [3]</h2>

<h2 id="cyl-mpg-wt-fitted-se-fit-resid-hat-sigma">cyl   mpg    wt  .fitted  .se.fit      .resid       .hat   .sigma</h2>

<h2 id="dbl-dbl-dbl-dbl-dbl-dbl-dbl-dbl"><dbl> <dbl> <dbl>    <dbl>    <dbl>       <dbl>      <dbl>    <dbl></h2>

<h2 id="1-4-22-8-2-320-26-47010-1-006720-3-67009741-0-09127118-3-261796">1      4  22.8 2.320 26.47010 1.006720 -3.67009741 0.09127118 3.261796</h2>

<h2 id="2-4-24-4-3-190-21-55719-1-951521-2-84281457-0-34297508-3-309771">2      4  24.4 3.190 21.55719 1.951521  2.84281457 0.34297508 3.309771</h2>

<h2 id="3-4-22-8-3-150-21-78307-1-888462-1-01693356-0-32116829-3-507377">3      4  22.8 3.150 21.78307 1.888462  1.01693356 0.32116829 3.507377</h2>

<h2 id="4-4-32-4-2-200-27-14774-1-017163-5-25225956-0-09317454-2-947803">4      4  32.4 2.200 27.14774 1.017163  5.25225956 0.09317454 2.947803</h2>

<h2 id="5-4-30-4-1-615-30-45125-1-596671-0-05125022-0-22958701-3-534359">5      4  30.4 1.615 30.45125 1.596671 -0.05125022 0.22958701 3.534359</h2>

<h2 id="6-4-33-9-1-835-29-20890-1-305700-4-69109534-0-15353342-3-040129">6      4  33.9 1.835 29.20890 1.305700  4.69109534 0.15353342 3.040129</h2>

<h2 id="7-4-21-5-2-465-25-65128-1-058052-4-15127874-0-10081613-3-177493">7      4  21.5 2.465 25.65128 1.058052 -4.15127874 0.10081613 3.177493</h2>

<h2 id="8-4-27-3-1-935-28-64420-1-196043-1-34420213-0-12882788-3-497551">8      4  27.3 1.935 28.64420 1.196043 -1.34420213 0.12882788 3.497551</h2>

<h2 id="9-4-26-0-2-140-27-48656-1-040267-1-48656195-0-09745541-3-490854">9      4  26.0 2.140 27.48656 1.040267 -1.48656195 0.09745541 3.490854</h2>

<h2 id="10-4-30-4-1-513-31-02725-1-747377-0-62724679-0-27497267-3-524811">10     4  30.4 1.513 31.02725 1.747377 -0.62724679 0.27497267 3.524811</h2>

<h2 id="toc_96">..   &hellip;   &hellip;   &hellip;      &hellip;      &hellip;         &hellip;        &hellip;      &hellip;</h2>

<h2 id="variables-not-shown-cooksd-dbl-std-resid-dbl">Variables not shown: .cooksd <dbl>, .std.resid <dbl>.</h2>

<p>{% endhighlight %}</p>

<p>One nice use case of <code>augment()</code> is for plotting fitted models against the data.</p>

<p>{% highlight r %}
subset_models %&gt;%
  augment(fit) %&gt;%
  ggplot +
  aes(
    y = mpg,
    x = wt,
    colour = factor(cyl)
    ) +
  geom_point() +
  geom_point(
    aes(
      y = .fitted,
      group = cyl
      ),
    colour = &ldquo;black&rdquo;
    )+
  geom_path(
    aes(
      y = .fitted,
      group = cyl
      )
    )
{% endhighlight %}</p>

<p><img src="/figures/2016-03-27-augment-plot-1.svg" alt="plot of chunk 2016-03-27-augment-plot" /></p>

<p>In this simple example, we could achieve the same just with <code>geom_smooth(aes(group=cyl), method=&quot;lm&quot;)</code>; however this would not be so easy with a more complicated model.</p>

<h2 id="purrr">purrr</h2>

<p>So what is new about <strong>purrr</strong>?
Well first off we can do similar things to <code>do()</code> using <code>map()</code>:</p>

<p>{% highlight r %}
mtcars %&gt;%
  split(.$cyl) %&gt;%
  map(~ lm(mpg ~ wt, data = .))
{% endhighlight %}</p>

<p>{% highlight text %}</p>

<h2 id="4">$<code>4</code></h2>

<h2 id="call">Call:</h2>

<h2 id="lm-formula-mpg-wt-data">lm(formula = mpg ~ wt, data = .)</h2>

<h2 id="coefficients">Coefficients:</h2>

<h2 id="intercept-wt">(Intercept)           wt</h2>

<h2 id="39-571-5-647">39.571       -5.647</h2>

<h2 id="6">$<code>6</code></h2>

<h2 id="call-1">Call:</h2>

<h2 id="lm-formula-mpg-wt-data-1">lm(formula = mpg ~ wt, data = .)</h2>

<h2 id="coefficients-1">Coefficients:</h2>

<h2 id="intercept-wt-1">(Intercept)           wt</h2>

<h2 id="28-41-2-78">28.41        -2.78</h2>

<h2 id="8">$<code>8</code></h2>

<h2 id="call-2">Call:</h2>

<h2 id="lm-formula-mpg-wt-data-2">lm(formula = mpg ~ wt, data = .)</h2>

<h2 id="coefficients-2">Coefficients:</h2>

<h2 id="intercept-wt-2">(Intercept)           wt</h2>

<h2 id="23-868-2-192">23.868       -2.192</h2>

<p>{% endhighlight %}</p>

<p>And we can keep adding <code>map()</code> functions to get the output we want:</p>

<p>{% highlight r %}
mtcars %&gt;%
  split(.$cyl) %&gt;%
  map(~ lm(mpg ~ wt, data = .)) %&gt;%
  map(summary)
{% endhighlight %}</p>

<p>{% highlight text %}</p>

<h2 id="4-1">$<code>4</code></h2>

<h2 id="call-3">Call:</h2>

<h2 id="lm-formula-mpg-wt-data-3">lm(formula = mpg ~ wt, data = .)</h2>

<h2 id="residuals">Residuals:</h2>

<h2 id="min-1q-median-3q-max">Min      1Q  Median      3Q     Max</h2>

<h2 id="4-1513-1-9795-0-6272-1-9299-5-2523">-4.1513 -1.9795 -0.6272  1.9299  5.2523</h2>

<h2 id="coefficients-3">Coefficients:</h2>

<h2 id="estimate-std-error-t-value-pr-t">Estimate Std. Error t value Pr(&gt;|t|)</h2>

<h2 id="intercept-39-571-4-347-9-104-7-77e-06">(Intercept)   39.571      4.347   9.104 7.77e-06 ***</h2>

<h2 id="wt-5-647-1-850-3-052-0-0137">wt            -5.647      1.850  -3.052   0.0137 *</h2>

<h2 id="toc_127">&mdash;</h2>

<h2 id="signif-codes-0-0-001-0-01-0-05-0-1-1">Signif. codes:  0 &lsquo;*<strong>&rsquo; 0.001 &lsquo;</strong>&rsquo; 0.01 &lsquo;*&rsquo; 0.05 &lsquo;.&rsquo; 0.1 &lsquo; &rsquo; 1</h2>

<h2 id="residual-standard-error-3-332-on-9-degrees-of-freedom">Residual standard error: 3.332 on 9 degrees of freedom</h2>

<h2 id="multiple-r-squared-0-5086-adjusted-r-squared-0-454">Multiple R-squared:  0.5086, Adjusted R-squared:  0.454</h2>

<h2 id="f-statistic-9-316-on-1-and-9-df-p-value-0-01374">F-statistic: 9.316 on 1 and 9 DF,  p-value: 0.01374</h2>

<h2 id="6-1">$<code>6</code></h2>

<h2 id="call-4">Call:</h2>

<h2 id="lm-formula-mpg-wt-data-4">lm(formula = mpg ~ wt, data = .)</h2>

<h2 id="residuals-1">Residuals:</h2>

<h2 id="mazda-rx4-mazda-rx4-wag-hornet-4-drive-valiant-merc-280">Mazda RX4  Mazda RX4 Wag Hornet 4 Drive        Valiant       Merc 280</h2>

<h2 id="0-1250-0-5840-1-9292-0-6897-0-3547">-0.1250         0.5840         1.9292        -0.6897         0.3547</h2>

<h2 id="merc-280c-ferrari-dino">Merc 280C   Ferrari Dino</h2>

<h2 id="1-0453-1-0080">-1.0453        -1.0080</h2>

<h2 id="coefficients-4">Coefficients:</h2>

<h2 id="estimate-std-error-t-value-pr-t-1">Estimate Std. Error t value Pr(&gt;|t|)</h2>

<h2 id="intercept-28-409-4-184-6-789-0-00105">(Intercept)   28.409      4.184   6.789  0.00105 **</h2>

<h2 id="wt-2-780-1-335-2-083-0-09176">wt            -2.780      1.335  -2.083  0.09176 .</h2>

<h2 id="toc_144">&mdash;</h2>

<h2 id="signif-codes-0-0-001-0-01-0-05-0-1-1-1">Signif. codes:  0 &lsquo;*<strong>&rsquo; 0.001 &lsquo;</strong>&rsquo; 0.01 &lsquo;*&rsquo; 0.05 &lsquo;.&rsquo; 0.1 &lsquo; &rsquo; 1</h2>

<h2 id="residual-standard-error-1-165-on-5-degrees-of-freedom">Residual standard error: 1.165 on 5 degrees of freedom</h2>

<h2 id="multiple-r-squared-0-4645-adjusted-r-squared-0-3574">Multiple R-squared:  0.4645, Adjusted R-squared:  0.3574</h2>

<h2 id="f-statistic-4-337-on-1-and-5-df-p-value-0-09176">F-statistic: 4.337 on 1 and 5 DF,  p-value: 0.09176</h2>

<h2 id="8-1">$<code>8</code></h2>

<h2 id="call-5">Call:</h2>

<h2 id="lm-formula-mpg-wt-data-5">lm(formula = mpg ~ wt, data = .)</h2>

<h2 id="residuals-2">Residuals:</h2>

<h2 id="min-1q-median-3q-max-1">Min      1Q  Median      3Q     Max</h2>

<h2 id="2-1491-1-4664-0-8458-1-5711-3-7619">-2.1491 -1.4664 -0.8458  1.5711  3.7619</h2>

<h2 id="coefficients-5">Coefficients:</h2>

<h2 id="estimate-std-error-t-value-pr-t-2">Estimate Std. Error t value Pr(&gt;|t|)</h2>

<h2 id="intercept-23-8680-3-0055-7-942-4-05e-06">(Intercept)  23.8680     3.0055   7.942 4.05e-06 ***</h2>

<h2 id="wt-2-1924-0-7392-2-966-0-0118">wt           -2.1924     0.7392  -2.966   0.0118 *</h2>

<h2 id="toc_159">&mdash;</h2>

<h2 id="signif-codes-0-0-001-0-01-0-05-0-1-1-2">Signif. codes:  0 &lsquo;*<strong>&rsquo; 0.001 &lsquo;</strong>&rsquo; 0.01 &lsquo;*&rsquo; 0.05 &lsquo;.&rsquo; 0.1 &lsquo; &rsquo; 1</h2>

<h2 id="residual-standard-error-2-024-on-12-degrees-of-freedom">Residual standard error: 2.024 on 12 degrees of freedom</h2>

<h2 id="multiple-r-squared-0-423-adjusted-r-squared-0-3749">Multiple R-squared:  0.423,  Adjusted R-squared:  0.3749</h2>

<h2 id="f-statistic-8-796-on-1-and-12-df-p-value-0-01179">F-statistic: 8.796 on 1 and 12 DF,  p-value: 0.01179</h2>

<p>{% endhighlight %}</p>

<blockquote>
<p>Note the three types of input to map(): a function, a formula (converted to an anonymous function), or a string (used to extract named components). <sup class="footnote-ref" id="fnref:1"><a rel="footnote" href="#fn:1">1</a></sup></p>
</blockquote>

<p>So to use a string this time, returning a double vector&hellip;</p>

<p>{% highlight r %}
mtcars %&gt;%
  split(.$cyl) %&gt;%
  map(~ lm(mpg ~ wt, data = .)) %&gt;%
  map(summary) %&gt;%
  map_dbl(&ldquo;r.squared&rdquo;)
{% endhighlight %}</p>

<p>{% highlight text %}</p>

<h2 id="4-6-8">4         6         8</h2>

<h2 id="0-5086326-0-4645102-0-4229655">0.5086326 0.4645102 0.4229655</h2>

<p>{% endhighlight %}</p>

<h3 id="creating-training-and-test-splits">Creating training and test splits</h3>

<p>A more complicated example that is a purrrfect use case is: creating splits in a dataset on which a model can be trained and then validated.</p>

<p>Here I shamelessly copy Hadley&rsquo;s example<sup class="footnote-ref" id="fnref:1"><a rel="footnote" href="#fn:1">1</a></sup>. Note that you will need the latest dev version of <strong>dplyr</strong> to run this correctly due to <a href="https://github.com/hadley/dplyr/issues/1447">this issue</a> (fixed in the next <strong>dplyr</strong> release &gt; 0.4.3).</p>

<p>First define a cost function on which to evaluate the models (in this case the mean squared difference (but this could be anything).</p>

<p>{% highlight r %}
msd &lt;- function(x, y) sqrt(mean((x - y) ^ 2))
{% endhighlight %}</p>

<p>And a function to generate $n$ random groups with a given probability</p>

<p>{% highlight r %}
random_group &lt;- function(n, probs) {
  probs &lt;- probs / sum(probs)
  g &lt;- findInterval(seq(0, 1, length = n), c(0, cumsum(probs)),
    rightmost.closed = TRUE)
  names(probs)[sample(g)]
}
{% endhighlight %}</p>

<p>And wrap this up in a function to replicate it&hellip;</p>

<p>{% highlight r %}
partition &lt;- function(df, n, probs) {
  replicate(n, split(df, random_group(nrow(df), probs)), FALSE) %&gt;%
    transpose() %&gt;%
    as_data_frame()
}
{% endhighlight %}</p>

<p>Note that this makes use of the new <code>purrr::transpose()</code> function which applies something like a matrix transpose to a list, and when coerced, returns a <code>data_frame</code> containing $n$ random splits of the data.</p>

<p>{% highlight r %}
boot &lt;- partition(mtcars, 100, c(training = 0.8, test = 0.2))
boot
{% endhighlight %}</p>

<p>{% highlight text %}</p>

<h2 id="source-local-data-frame-100-x-2">Source: local data frame [100 x 2]</h2>

<h2 id="test-training">test             training</h2>

<h2 id="list-list"><list>               <list></h2>

<h2 id="1-data-frame-7-11-data-frame-25-11">1  <data.frame [7,11]> <data.frame [25,11]></h2>

<h2 id="2-data-frame-7-11-data-frame-25-11">2  <data.frame [7,11]> <data.frame [25,11]></h2>

<h2 id="3-data-frame-7-11-data-frame-25-11">3  <data.frame [7,11]> <data.frame [25,11]></h2>

<h2 id="4-data-frame-7-11-data-frame-25-11">4  <data.frame [7,11]> <data.frame [25,11]></h2>

<h2 id="5-data-frame-7-11-data-frame-25-11">5  <data.frame [7,11]> <data.frame [25,11]></h2>

<h2 id="6-data-frame-7-11-data-frame-25-11">6  <data.frame [7,11]> <data.frame [25,11]></h2>

<h2 id="7-data-frame-7-11-data-frame-25-11">7  <data.frame [7,11]> <data.frame [25,11]></h2>

<h2 id="8-data-frame-7-11-data-frame-25-11">8  <data.frame [7,11]> <data.frame [25,11]></h2>

<h2 id="9-data-frame-7-11-data-frame-25-11">9  <data.frame [7,11]> <data.frame [25,11]></h2>

<h2 id="10-data-frame-7-11-data-frame-25-11">10 <data.frame [7,11]> <data.frame [25,11]></h2>

<h2 id="toc_180">..                 &hellip;                  &hellip;</h2>

<p>{% endhighlight %}</p>

<p>Finally use <code>map()</code> to:</p>

<ul>
<li>Fit simple linear models to the data as before.<br /></li>
<li>Make predictions based on those models on the test dataset.<br /></li>
<li>Evaluate model performance using the cost function (<code>msd</code>).<br /></li>
</ul>

<p>{% highlight r %}
boot &lt;- boot %&gt;%
  dplyr::mutate(
  models = map(training, ~ lm(mpg ~ wt, data = .)),
  preds = map2(models, test, predict),
  diffs = map2(preds, test %&gt;% map(&ldquo;mpg&rdquo;), msd)
)
{% endhighlight %}</p>

<p>This still results in a data frame, but with three new list columns. We need to subset out the columns of interest:</p>

<p>{% highlight r %}
diffs &lt;- boot %$%
  diffs %&gt;%
  unlist</p>

<p>diffs
{% endhighlight %}</p>

<p>{% highlight text %}</p>

<h2 id="1-1-929788-3-068123-3-743168-3-938367-2-779580-2-104018-2-057479"><a href="1" title="https://github.com/hadley/purrr
">1</a> 1.929788 3.068123 3.743168 3.938367 2.779580 2.104018 2.057479</h2>

<h2 id="8-4-232115-2-373427-3-735713-2-605725-4-390466-3-523725-3-931919">[8] 4.232115 2.373427 3.735713 2.605725 4.390466 3.523725 3.931919</h2>

<h2 id="15-3-869292-1-991069-4-462875-4-756585-3-193928-3-263839-2-689011">[15] 3.869292 1.991069 4.462875 4.756585 3.193928 3.263839 2.689011</h2>

<h2 id="22-3-863989-2-761086-3-489189-3-132539-1-992176-2-380095-3-012068">[22] 3.863989 2.761086 3.489189 3.132539 1.992176 2.380095 3.012068</h2>

<h2 id="29-3-359432-2-558984-2-436260-2-239631-3-620960-4-568904-3-478480">[29] 3.359432 2.558984 2.436260 2.239631 3.620960 4.568904 3.478480</h2>

<h2 id="36-3-417382-2-831235-2-557201-1-990983-3-582177-2-330317-3-786463">[36] 3.417382 2.831235 2.557201 1.990983 3.582177 2.330317 3.786463</h2>

<h2 id="43-5-127931-3-900516-4-797562-2-330468-2-327044-2-717241-2-224535">[43] 5.127931 3.900516 4.797562 2.330468 2.327044 2.717241 2.224535</h2>

<h2 id="50-2-339870-2-959194-2-742073-3-207509-2-706517-2-576143-2-247355">[50] 2.339870 2.959194 2.742073 3.207509 2.706517 2.576143 2.247355</h2>

<h2 id="57-2-381469-1-280311-4-338375-4-092059-2-278560-2-452873-2-210257">[57] 2.381469 1.280311 4.338375 4.092059 2.278560 2.452873 2.210257</h2>

<h2 id="64-3-189066-2-626947-2-715859-3-368478-2-021571-3-364935-3-142655">[64] 3.189066 2.626947 2.715859 3.368478 2.021571 3.364935 3.142655</h2>

<h2 id="71-3-748013-3-292915-4-086842-3-344975-2-309361-4-046942-1-999605">[71] 3.748013 3.292915 4.086842 3.344975 2.309361 4.046942 1.999605</h2>

<h2 id="78-1-724928-4-473536-3-568275-3-451020-3-883805-2-501655-3-293562">[78] 1.724928 4.473536 3.568275 3.451020 3.883805 2.501655 3.293562</h2>

<h2 id="85-3-603897-1-975380-4-202382-2-298882-3-884109-1-833734-2-644478">[85] 3.603897 1.975380 4.202382 2.298882 3.884109 1.833734 2.644478</h2>

<h2 id="92-3-896363-3-532942-3-114910-3-928856-3-357457-2-155898-4-509818">[92] 3.896363 3.532942 3.114910 3.928856 3.357457 2.155898 4.509818</h2>

<h2 id="99-2-075142-4-023687">[99] 2.075142 4.023687</h2>

<p>{% endhighlight %}</p>

<h2 id="rounding-up">Rounding up</h2>

<p>I&rsquo;ve been playing with some things in this post that I am just getting to grips with, but look to be some really powerful additions to the hadleyverse, and the R landscape in general.
Keeping an eye on the development of <strong>purrr</strong> would be a good move I think.</p>

<h2 id="references">References</h2>

<ul>
<li><a href="https://github.com/hadley/purrr">https://github.com/hadley/purrr</a><br /></li>
<li><a href="http://r4ds.had.co.nz/lists.html">http://r4ds.had.co.nz/lists.html</a><br /></li>
<li><a href="http://r4ds.had.co.nz/model-assessment.html">http://r4ds.had.co.nz/model-assessment.html</a><br /></li>
<li><a href="https://cran.r-project.org/web/packages/broom/vignettes/kmeans.html">https://cran.r-project.org/web/packages/broom/vignettes/kmeans.html</a><br /></li>
<li><a href="https://cran.r-project.org/web/packages/broom/vignettes/broom.html">https://cran.r-project.org/web/packages/broom/vignettes/broom.html</a><br /></li>
</ul>
<div class="footnotes">

<hr />

<ol>
<li id="fn:1"><a href="https://github.com/hadley/purrr">https://github.com/hadley/purrr</a>
 <a class="footnote-return" href="#fnref:1"><sup>[return]</sup></a></li>
</ol>
</div>

    </div>
  </article>

  


</main>

      <footer class="footer">
        <ul class="footer-links">
          <li>
            <a href="/index.xml" type="application/rss+xml" target="_blank">RSS feed</a>
          </li>
          <li>
            <a href="https://gohugo.io/" class="footer-links-kudos">Made with <img src="/images/hugo-logo.png" width="22" height="22"></a>
          </li>
        </ul>
      </footer>

    </div>
    

    
<script src="/js/math-code.js"></script>
<script async src="//cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>


    
  </body>
</html>

